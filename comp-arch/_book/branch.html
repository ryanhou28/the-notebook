<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>7&nbsp; Instruction Flow – Empty Book Template</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cache.html" rel="next">
<link href="./ooo-memory.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b6b4e5ca75ba39a1f986e6d06a1c53b5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./branch.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Instruction Flow</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Empty Book Template</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Performance, Power, ISA</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inorder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">In-Order CPU, Pipelining</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ooo-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Out-of-Order - Dynamic Scheduling, Tomasulo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p6r10k.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Out-of-Order - Speculation, Precise Interrupts, Superscalar</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ooo-memory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Memory Disambiguation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./branch.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Instruction Flow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cache.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Caches</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prefetch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Prefetching</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vmem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">vmem.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiproc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">multiproc.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./smt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">smt.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">dlp.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#instruction-fetch-buffer" id="toc-instruction-fetch-buffer" class="nav-link active" data-scroll-target="#instruction-fetch-buffer"><span class="header-section-number">7.1</span> Instruction Fetch Buffer</a></li>
  <li><a href="#branch-prediction" id="toc-branch-prediction" class="nav-link" data-scroll-target="#branch-prediction"><span class="header-section-number">7.2</span> Branch Prediction</a></li>
  <li><a href="#branch-target-buffer-btb" id="toc-branch-target-buffer-btb" class="nav-link" data-scroll-target="#branch-target-buffer-btb"><span class="header-section-number">7.3</span> Branch Target Buffer (BTB)</a></li>
  <li><a href="#return-address-stack" id="toc-return-address-stack" class="nav-link" data-scroll-target="#return-address-stack"><span class="header-section-number">7.4</span> Return Address Stack</a></li>
  <li><a href="#branch-direction-prediction" id="toc-branch-direction-prediction" class="nav-link" data-scroll-target="#branch-direction-prediction"><span class="header-section-number">7.5</span> Branch Direction Prediction</a>
  <ul class="collapse">
  <li><a href="#branch-history-table-bht" id="toc-branch-history-table-bht" class="nav-link" data-scroll-target="#branch-history-table-bht"><span class="header-section-number">7.5.1</span> Branch History Table (BHT)</a></li>
  <li><a href="#tage" id="toc-tage" class="nav-link" data-scroll-target="#tage"><span class="header-section-number">7.5.2</span> TAGE</a></li>
  <li><a href="#branch-predictor-summary" id="toc-branch-predictor-summary" class="nav-link" data-scroll-target="#branch-predictor-summary"><span class="header-section-number">7.5.3</span> Branch Predictor Summary</a></li>
  </ul></li>
  <li><a href="#early-branch-recovery" id="toc-early-branch-recovery" class="nav-link" data-scroll-target="#early-branch-recovery"><span class="header-section-number">7.6</span> Early Branch Recovery</a>
  <ul class="collapse">
  <li><a href="#dispatch-stage" id="toc-dispatch-stage" class="nav-link" data-scroll-target="#dispatch-stage"><span class="header-section-number">7.6.1</span> Dispatch Stage</a></li>
  <li><a href="#branch-resolution---mispredict" id="toc-branch-resolution---mispredict" class="nav-link" data-scroll-target="#branch-resolution---mispredict"><span class="header-section-number">7.6.2</span> Branch Resolution - Mispredict</a></li>
  <li><a href="#branch-resolution---correct-prediction" id="toc-branch-resolution---correct-prediction" class="nav-link" data-scroll-target="#branch-resolution---correct-prediction"><span class="header-section-number">7.6.3</span> Branch Resolution - Correct Prediction</a></li>
  </ul></li>
  <li><a href="#aside-ports-vs-banks" id="toc-aside-ports-vs-banks" class="nav-link" data-scroll-target="#aside-ports-vs-banks"><span class="header-section-number">7.7</span> Aside: Ports vs Banks</a></li>
  <li><a href="#wide-instruction-fetch" id="toc-wide-instruction-fetch" class="nav-link" data-scroll-target="#wide-instruction-fetch"><span class="header-section-number">7.8</span> Wide Instruction Fetch</a></li>
  <li><a href="#trace-cache" id="toc-trace-cache" class="nav-link" data-scroll-target="#trace-cache"><span class="header-section-number">7.9</span> Trace Cache</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Instruction Flow</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Topics:</p>
<ul>
<li>Instruction Buffers</li>
<li>Return Address Stack</li>
<li>Correlated Branch Predictors</li>
</ul>
<p>Resources: H&amp;P Chp3.3,3.9</p>
<p><img src="images/branch/flowmodel.png" class="img-fluid"></p>
<p><img src="images/branch/470roadmap.png" class="img-fluid"></p>
<p><img src="images/branch/review-branches.png" class="img-fluid"></p>
<p><img src="images/branch/cond-resol.png" class="img-fluid"></p>
<ul>
<li>Where do we resolve the branch? Depends on the type!</li>
</ul>
<p><img src="images/branch/target-addr.png" class="img-fluid"></p>
<ul>
<li>PC relative branches: don’t need to wait long</li>
<li>Register indirect branch: need the value of the register, need to wait until instruction can be issued (ie when the registers are available)</li>
<li>Register indirect + offset (most general way):
<ul>
<li>Need to calculate the address, thus is resolved at EX stage</li>
</ul></li>
</ul>
<p><strong>Performance Penalties of Branches</strong></p>
<ul>
<li>Use up execution resources</li>
<li>Fragmentation of I-cache lines</li>
<li>Disruption of seq. control flow
<ul>
<li>Need to determine direction and target</li>
<li>Often results in stalls and squashes</li>
</ul></li>
</ul>
<section id="instruction-fetch-buffer" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="instruction-fetch-buffer"><span class="header-section-number">7.1</span> Instruction Fetch Buffer</h2>
<p><img src="images/branch/i-fetch-buff.png" class="img-fluid"></p>
</section>
<section id="branch-prediction" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="branch-prediction"><span class="header-section-number">7.2</span> Branch Prediction</h2>
<p>Two high level strategies:</p>
<ul>
<li>Static - same prediction for a branch everytime
<ul>
<li>implement in compiler, by programmer, or in HW</li>
<li>simple HW implementation</li>
</ul></li>
<li>Dynamic: some runtime info is used to make (potentially) different prediction each iteration
<ul>
<li>implemented in HW</li>
<li>need more HW, but better performance (most of the time, depends on workload)</li>
</ul></li>
</ul>
<p><img src="images/branch/bp-strats.png" class="img-fluid"></p>
<p><img src="images/branch/dyn-branch-pred.png" class="img-fluid"></p>
<ul>
<li>Target predictor feeds the PC</li>
<li>Direction predictor only applies to conditionals
<ul>
<li>since nonconditionals (eg jal) are always taken</li>
</ul></li>
</ul>
</section>
<section id="branch-target-buffer-btb" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="branch-target-buffer-btb"><span class="header-section-number">7.3</span> Branch Target Buffer (BTB)</h2>
<p><img src="images/branch/btb.png" class="img-fluid"></p>
<ul>
<li>Basically a small cache of past branch targets</li>
<li>Use small set of the address (don’t compare whole address)</li>
<li>Use part of the PC as the index into the cache</li>
<li>If we’ve seen a branch to this before (recently): predict taken</li>
<li>If we haven’t seen this (recently): predict not taken</li>
</ul>
<p><img src="images/branch/why-btb.png" class="img-fluid"></p>
</section>
<section id="return-address-stack" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="return-address-stack"><span class="header-section-number">7.4</span> Return Address Stack</h2>
<p><img src="images/branch/ras-.png" class="img-fluid"></p>
<ul>
<li>As we access the instruction cache, we also send that PC to the BTB
<ul>
<li>Every time we have a function call (jump instruction), we also put the return address on the return address stack (RAS), and maintain it in a last in first out (LIFO) order</li>
<li>Now how do we choose whether to use the BTB or RAS’s target address? We need to figure out if the instruction we’re fetching is a return (unconditional jump)</li>
<li>We could include a couple extra bits to the instruction cache that indicates whether the instruction was a return instruction last time or if it was a conditional branch</li>
<li>Access the BTB and RAS in parallel and these extra bits in the i-cache will indicate to whether the instruction we’re accessing was a return instruction last time we accessed it</li>
<li>Sometimes encoded as a single bit in the ISA that indicates if it’s a return instruction
<ul>
<li>These extra bits are indicated by the red blocks highlighted in the I-cache</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="branch-direction-prediction" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="branch-direction-prediction"><span class="header-section-number">7.5</span> Branch Direction Prediction</h2>
<p><strong>Direction Predictor (DIRP)</strong></p>
<ul>
<li>Map conditional branch PC to taken/not-taken (T/N) decision</li>
<li>90%+ one way or the other is considered a “biased”
<ul>
<li>individual conditional branches are often unbiased or weakly biased</li>
</ul></li>
</ul>
<section id="branch-history-table-bht" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="branch-history-table-bht"><span class="header-section-number">7.5.1</span> Branch History Table (BHT)</h3>
<p><img src="images/branch/bht.png" class="img-fluid"></p>
<ul>
<li>Add a table of branch histories</li>
<li>Index of the table = PC of the instruction
<ul>
<li>Use PC to index into the table and check where the branch went last time</li>
</ul></li>
<li>No tags because it isn’t to determine aliases, since aliasing means it’s hard to make sophisticated guess anyway</li>
<li>Everytime a <strong>branch is retired</strong>, we write into this table</li>
<li>Simple BHT guesses the same thing as before</li>
</ul>
<section id="limitations-of-simple-prediction" class="level4" data-number="7.5.1.1">
<h4 data-number="7.5.1.1" class="anchored" data-anchor-id="limitations-of-simple-prediction"><span class="header-section-number">7.5.1.1</span> Limitations of Simple Prediction</h4>
<p>Consider an inner loop branch (nested for loops)</p>
<ul>
<li>branch predictor “changes its mind too quickly”, resulting in many mispredicts</li>
</ul>
<p><img src="images/branch/simple-bht.png" class="img-fluid"></p>
</section>
<section id="two-bit-saturating-counters-2bc" class="level4" data-number="7.5.1.2">
<h4 data-number="7.5.1.2" class="anchored" data-anchor-id="two-bit-saturating-counters-2bc"><span class="header-section-number">7.5.1.2</span> Two-Bit Saturating Counters (2bc)</h4>
<p><img src="images/branch/2bc-pred.png" class="img-fluid"></p>
<ul>
<li>Strongly Not taken, not taken, taken, strongly taken</li>
<li>Mis-predict lowers confidence</li>
<li>Correct prediction increases confidence</li>
</ul>
<p><img src="images/branch/other-2bc-pred.png" class="img-fluid"></p>
</section>
<section id="correlated-predictor" class="level4" data-number="7.5.1.3">
<h4 data-number="7.5.1.3" class="anchored" data-anchor-id="correlated-predictor"><span class="header-section-number">7.5.1.3</span> Correlated Predictor</h4>
<p><img src="images/branch/corr-pred.png" class="img-fluid"></p>
<ul>
<li>Also looks at the outcome of previous branches</li>
<li>Branch history rable leads to a local history table
<ul>
<li>Stores previous outcomes</li>
<li>Eg the 8 previous outcomes of the branch is 10101010
<ul>
<li>Last time we saw this outcome, then we assume that this keeps happening</li>
</ul></li>
</ul></li>
<li>Takes much longer to warm up</li>
</ul>
<p><img src="images/branch/corr-pred-ex.png" class="img-fluid"></p>
<p><img src="images/branch/corr-pred-ex-size.png" class="img-fluid"></p>
</section>
<section id="global-branch-prediction" class="level4" data-number="7.5.1.4">
<h4 data-number="7.5.1.4" class="anchored" data-anchor-id="global-branch-prediction"><span class="header-section-number">7.5.1.4</span> Global Branch Prediction</h4>
<p>Instead of using a branch’s own history to make predictions, we could also use the direction of all (global) branches to correlate outcomes</p>
<p><img src="images/branch/global-bp.png" class="img-fluid"></p>
</section>
<section id="correlated-predictor-design-space" class="level4" data-number="7.5.1.5">
<h4 data-number="7.5.1.5" class="anchored" data-anchor-id="correlated-predictor-design-space"><span class="header-section-number">7.5.1.5</span> Correlated Predictor Design Space</h4>
<p><img src="images/branch/corr-pred-design-space.png" class="img-fluid"></p>
</section>
<section id="gshare" class="level4" data-number="7.5.1.6">
<h4 data-number="7.5.1.6" class="anchored" data-anchor-id="gshare"><span class="header-section-number">7.5.1.6</span> GShare</h4>
<p><img src="images/branch/gshare.png" class="img-fluid"></p>
</section>
<section id="hybrid-tournament-predictor" class="level4" data-number="7.5.1.7">
<h4 data-number="7.5.1.7" class="anchored" data-anchor-id="hybrid-tournament-predictor"><span class="header-section-number">7.5.1.7</span> Hybrid (Tournament) Predictor</h4>
<p><img src="images/branch/hyb-pred.png" class="img-fluid"></p>
</section>
</section>
<section id="tage" class="level3" data-number="7.5.2">
<h3 data-number="7.5.2" class="anchored" data-anchor-id="tage"><span class="header-section-number">7.5.2</span> TAGE</h3>
<p>TAGE (TAged GEometric) predictor</p>
<ul>
<li>Multiple predictors using different history lengths</li>
</ul>
<section id="perceptron" class="level4" data-number="7.5.2.1">
<h4 data-number="7.5.2.1" class="anchored" data-anchor-id="perceptron"><span class="header-section-number">7.5.2.1</span> Perceptron</h4>
<ul>
<li>Use HW perceptrons to learn correlation with other branches</li>
<li>Allows for much longer histories than traditional methods
<ul>
<li>Traditionally, HW grows exp. with history length</li>
<li>Perceptron scales linearly</li>
</ul></li>
</ul>
</section>
</section>
<section id="branch-predictor-summary" class="level3" data-number="7.5.3">
<h3 data-number="7.5.3" class="anchored" data-anchor-id="branch-predictor-summary"><span class="header-section-number">7.5.3</span> Branch Predictor Summary</h3>
<p><img src="images/branch/branch-pred-summary.png" class="img-fluid"></p>
<p><img src="images/branch/branch-pred-challenge.png" class="img-fluid"></p>
</section>
</section>
<section id="early-branch-recovery" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="early-branch-recovery"><span class="header-section-number">7.6</span> Early Branch Recovery</h2>
<p>Previously to do branch recovery, we waited until mispredicted branch gets retired in the ROB, then we clear out everything in-flight to start over again. However this is a lot of latency especially in wide instruction windows. Idea with early branch recovery is that we start squashing wrong instructions right as we know the branch is mispredicted. We update selectively what instructions get squashed</p>
<p><img src="images/branch/earlybranchrecov.png" class="img-fluid"></p>
<ul>
<li>Everytime we have a branch, take a snapshot of all instructions older than the branch (ones we don’t squash), and ones after (potentially squash)</li>
<li>Every time we dispatch an instruction, going to copy the current state of the branch mask register into the RS
<ul>
<li>Eg, b-mask of 1000 is essentially saying that this instruction is only in the processor because we assumed that this branch was speculated correctly, if this branch is actually mis-speculated then it’s not supposed to be getting executed and should be squashed</li>
<li>Then a branch mask of 1100 would be based on speculating the two branches correctly, etc</li>
</ul></li>
</ul>
<section id="dispatch-stage" class="level3" data-number="7.6.1">
<h3 data-number="7.6.1" class="anchored" data-anchor-id="dispatch-stage"><span class="header-section-number">7.6.1</span> Dispatch Stage</h3>
<p><img src="images/branch/earlybranch-dispatch.png" class="img-fluid"></p>
</section>
<section id="branch-resolution---mispredict" class="level3" data-number="7.6.2">
<h3 data-number="7.6.2" class="anchored" data-anchor-id="branch-resolution---mispredict"><span class="header-section-number">7.6.2</span> Branch Resolution - Mispredict</h3>
<p><img src="images/branch/earlybranch-mispred.png" class="img-fluid"></p>
</section>
<section id="branch-resolution---correct-prediction" class="level3" data-number="7.6.3">
<h3 data-number="7.6.3" class="anchored" data-anchor-id="branch-resolution---correct-prediction"><span class="header-section-number">7.6.3</span> Branch Resolution - Correct Prediction</h3>
<p><img src="images/branch/earlybranch-correct-pred.png" class="img-fluid"></p>
<ul>
<li>If the prediction is correct, once we resolve the branch and it’s correct, we can clear out that branch stack entry and clear that bit in the b-mask</li>
<li>We also have to broadcast that the branch was correctly predicted to clear that bit for the b-mask register and for every b-mask in the pipeline</li>
<li>Since we might reallocate that branch stack entry for another branch now</li>
</ul>
</section>
</section>
<section id="aside-ports-vs-banks" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="aside-ports-vs-banks"><span class="header-section-number">7.7</span> Aside: Ports vs Banks</h2>
<p><img src="images/branch/portsbanks.png" class="img-fluid"></p>
<p><img src="images/branch/portsbanks2.png" class="img-fluid"></p>
</section>
<section id="wide-instruction-fetch" class="level2" data-number="7.8">
<h2 data-number="7.8" class="anchored" data-anchor-id="wide-instruction-fetch"><span class="header-section-number">7.8</span> Wide Instruction Fetch</h2>
<ul>
<li>Average basic block size:
<ul>
<li>integer code: 4-6 instructions</li>
<li>floating point code: 6-10 instructions</li>
</ul></li>
<li>Major challenges:
<ul>
<li>Multiple-branch prediction
<ul>
<li>If we have multiple branch predictions in a single block we’re fetching, how do we deal with that?</li>
</ul></li>
<li>Alignment
<ul>
<li>Instructions we want to fetch may not be aligned in the way we get our data</li>
</ul></li>
</ul></li>
</ul>
<p><img src="images/branch/wide-i-fetch-issues.png" class="img-fluid"></p>
<p><img src="images/branch/wide-fetch-seq.png" class="img-fluid"></p>
<p><img src="images/branch/widefetch-nonseq.png" class="img-fluid"></p>
<p><img src="images/branch/multi-branch-pred1.png" class="img-fluid"></p>
<p><img src="images/branch/multi-branch-pred.png" class="img-fluid"></p>
<p><img src="images/branch/multi-branch-pred-b.png" class="img-fluid"></p>
<p><img src="images/branch/multi-pred-taken-br.png" class="img-fluid"></p>
</section>
<section id="trace-cache" class="level2" data-number="7.9">
<h2 data-number="7.9" class="anchored" data-anchor-id="trace-cache"><span class="header-section-number">7.9</span> Trace Cache</h2>
<p><img src="images/branch/tracecache-mot.png" class="img-fluid"></p>
<p><img src="images/branch/tracecache.png" class="img-fluid"></p>
<p><img src="images/branch/tracecache-ex.png" class="img-fluid"></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ooo-memory.html" class="pagination-link" aria-label="Memory Disambiguation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Memory Disambiguation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cache.html" class="pagination-link" aria-label="Caches">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Caches</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>