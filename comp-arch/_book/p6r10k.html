<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>5&nbsp; Out-of-Order - Speculation, Precise Interrupts, Superscalar – Computer Architecture</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./ooo-memory.html" rel="next">
<link href="./ooo-basics.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b6b4e5ca75ba39a1f986e6d06a1c53b5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./p6r10k.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Out-of-Order - Speculation, Precise Interrupts, Superscalar</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Computer Architecture</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Performance, Power, ISA</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inorder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">In-Order CPU, Pipelining</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ooo-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Out-of-Order - Dynamic Scheduling, Tomasulo</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p6r10k.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Out-of-Order - Speculation, Precise Interrupts, Superscalar</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ooo-memory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Memory Disambiguation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./branch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Instruction Flow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cache.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Caches</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prefetch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Prefetching</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vmem.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Virtual Memory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiproc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">multiproc.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./smt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">smt.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">dlp.html</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#superscalar" id="toc-superscalar" class="nav-link active" data-scroll-target="#superscalar"><span class="header-section-number">5.1</span> Superscalar</a>
  <ul class="collapse">
  <li><a href="#superscalar-select-logic" id="toc-superscalar-select-logic" class="nav-link" data-scroll-target="#superscalar-select-logic"><span class="header-section-number">5.1.1</span> Superscalar Select Logic</a></li>
  </ul></li>
  <li><a href="#bypassing" id="toc-bypassing" class="nav-link" data-scroll-target="#bypassing"><span class="header-section-number">5.2</span> Bypassing</a></li>
  <li><a href="#interrupts-exceptions" id="toc-interrupts-exceptions" class="nav-link" data-scroll-target="#interrupts-exceptions"><span class="header-section-number">5.3</span> Interrupts &amp; Exceptions</a>
  <ul class="collapse">
  <li><a href="#precise-state" id="toc-precise-state" class="nav-link" data-scroll-target="#precise-state"><span class="header-section-number">5.3.1</span> Precise State</a></li>
  <li><a href="#asides---rob-and-rs-sizing" id="toc-asides---rob-and-rs-sizing" class="nav-link" data-scroll-target="#asides---rob-and-rs-sizing"><span class="header-section-number">5.3.2</span> Asides - ROB and RS Sizing</a></li>
  <li><a href="#complete-retire" id="toc-complete-retire" class="nav-link" data-scroll-target="#complete-retire"><span class="header-section-number">5.3.3</span> Complete &amp; Retire</a></li>
  </ul></li>
  <li><a href="#p6-style" id="toc-p6-style" class="nav-link" data-scroll-target="#p6-style"><span class="header-section-number">5.4</span> P6 Style</a>
  <ul class="collapse">
  <li><a href="#data-structures" id="toc-data-structures" class="nav-link" data-scroll-target="#data-structures"><span class="header-section-number">5.4.1</span> Data Structures</a></li>
  <li><a href="#pipeline" id="toc-pipeline" class="nav-link" data-scroll-target="#pipeline"><span class="header-section-number">5.4.2</span> Pipeline</a></li>
  <li><a href="#p6-dispatch" id="toc-p6-dispatch" class="nav-link" data-scroll-target="#p6-dispatch"><span class="header-section-number">5.4.3</span> P6 Dispatch</a></li>
  <li><a href="#p6-complete" id="toc-p6-complete" class="nav-link" data-scroll-target="#p6-complete"><span class="header-section-number">5.4.4</span> P6 Complete</a></li>
  <li><a href="#p6-retire" id="toc-p6-retire" class="nav-link" data-scroll-target="#p6-retire"><span class="header-section-number">5.4.5</span> P6 Retire</a></li>
  <li><a href="#precise-state-in-p6" id="toc-precise-state-in-p6" class="nav-link" data-scroll-target="#precise-state-in-p6"><span class="header-section-number">5.4.6</span> Precise State in P6</a></li>
  <li><a href="#p6" id="toc-p6" class="nav-link" data-scroll-target="#p6"><span class="header-section-number">5.4.7</span> P6</a></li>
  </ul></li>
  <li><a href="#mips-r10k" id="toc-mips-r10k" class="nav-link" data-scroll-target="#mips-r10k"><span class="header-section-number">5.5</span> MIPS R10K</a>
  <ul class="collapse">
  <li><a href="#r10k-register-renaming" id="toc-r10k-register-renaming" class="nav-link" data-scroll-target="#r10k-register-renaming"><span class="header-section-number">5.5.1</span> R10K Register Renaming</a></li>
  <li><a href="#r10k-data-structures" id="toc-r10k-data-structures" class="nav-link" data-scroll-target="#r10k-data-structures"><span class="header-section-number">5.5.2</span> R10K Data Structures</a></li>
  <li><a href="#r10k-pipeline" id="toc-r10k-pipeline" class="nav-link" data-scroll-target="#r10k-pipeline"><span class="header-section-number">5.5.3</span> R10K Pipeline</a></li>
  <li><a href="#dispatch" id="toc-dispatch" class="nav-link" data-scroll-target="#dispatch"><span class="header-section-number">5.5.4</span> Dispatch</a></li>
  <li><a href="#complete" id="toc-complete" class="nav-link" data-scroll-target="#complete"><span class="header-section-number">5.5.5</span> Complete</a></li>
  <li><a href="#retire" id="toc-retire" class="nav-link" data-scroll-target="#retire"><span class="header-section-number">5.5.6</span> Retire</a></li>
  <li><a href="#precise-state-in-r10k" id="toc-precise-state-in-r10k" class="nav-link" data-scroll-target="#precise-state-in-r10k"><span class="header-section-number">5.5.7</span> Precise State in R10k</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">5.6</span> Summary</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples"><span class="header-section-number">5.7</span> Examples</a>
  <ul class="collapse">
  <li><a href="#p6-execution" id="toc-p6-execution" class="nav-link" data-scroll-target="#p6-execution"><span class="header-section-number">5.7.1</span> P6 Execution</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Out-of-Order - Speculation, Precise Interrupts, Superscalar</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="superscalar" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="superscalar"><span class="header-section-number">5.1</span> Superscalar</h2>
<p><strong>Superscalar</strong> refers to issuing multiple instructions at the same time</p>
<ul>
<li>Dynamic scheduling and multiple issue are orthogonal techniques
<ul>
<li>Gives us 2 dimensions of scaling:
<ul>
<li>N: Superscalar width (number of parallel operations)</li>
<li>W: Window Size (number of reservation stations)
<ul>
<li>i.e.&nbsp;how many instructions we can read into the processor and choose to re-order among those</li>
<li>Determines # of independent ins. that can be operated on in parallel</li>
<li>Directly limits ILP (since it controls how many instructions can wait for execution)</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>Scaling for an N-by-W Tomasulo:</p>
<ul>
<li>RS:
<ul>
<li>N tag/value write ports (Dispatch)</li>
<li>N value read ports (Issue)</li>
<li>2N tag CAMs (Writeback)
<ul>
<li>Each RS entry needs to search for operand tag, and we have 2 source regs (thus 2 tag CAMs per RS entry)</li>
</ul></li>
</ul></li>
<li>Select Logic (Issue):
<ul>
<li>W to N priority encoder
<ul>
<li>to select N instructions to issue out of window W</li>
</ul></li>
</ul></li>
<li>Map Table
<ul>
<li>2N read ports (Dispatch)
<ul>
<li>Read 2N (2 reg per instruction)</li>
</ul></li>
<li>N write ports (Dispatch)
<ul>
<li>N instructions could be written to, need N ports to update mapping</li>
</ul></li>
</ul></li>
<li>Register File
<ul>
<li>2N read ports (Dispatch)</li>
<li>N write ports (Writeback)
<ul>
<li>Similar read/write ports as Map Table (2 read for 2 source regs per ins, N write for 1 destReg per ins)</li>
</ul></li>
</ul></li>
<li>CDB:
<ul>
<li>N (Writeback)</li>
</ul></li>
</ul>
<p>What is hard to scale up?</p>
<ul>
<li>Select logic tends to be difficult to scale up</li>
<li>RS is pretty expensive</li>
<li>CDB also takes up a lot of space and power! Routing overhead of CDB is very significant! Difficult to design</li>
</ul>
<p>Note</p>
<p>Kind of settled in industry that around 5-way superscalar is where we get a lot of benefits before diminishing returns (before starting to use too much power and add complexity / slows pipelines)</p>
<section id="superscalar-select-logic" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="superscalar-select-logic"><span class="header-section-number">5.1.1</span> Superscalar Select Logic</h3>
<ul>
<li>Superscalar select logic: W-&gt;N priority encoder
<ul>
<li>Complicated (complexity of <span class="math inline">\(N^2log(W)\)</span>)</li>
<li>Can be simplified with different designs</li>
</ul></li>
<li>Technique: Split design - Distributed Reservation Station
<ul>
<li>Divide RS into N banks: (1 per FU)</li>
<li>Thus need to implement N separate W/N to 1 encoders</li>
<li>Much simpler complexity: <span class="math inline">\(Nlog(W/N)\)</span></li>
<li>Con: Much less scheduling flexibility
<ul>
<li>Other FU might be free, but a RS bank is tied to one FU</li>
<li>Possible load imbalance between banks</li>
</ul></li>
</ul></li>
<li>FIFO Design [Palacharla+]
<ul>
<li>Only issue the head of each RS bank</li>
<li>Simpler: No need for select logic at all</li>
<li>Con: Less scheduling flexibility (however, surprisingly not that bad)
<ul>
<li>Cannot issue OoO within a bank!</li>
<li>Load balancing issues</li>
</ul></li>
</ul></li>
</ul>
</section>
</section>
<section id="bypassing" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="bypassing"><span class="header-section-number">5.2</span> Bypassing</h2>
<p><img src="images/p6r10k/bypassing-1.png" class="img-fluid"></p>
<p><img src="images/p6r10k/bypassing-2.png" class="img-fluid"></p>
<ul>
<li>Bypassing in OoO is tricky!</li>
</ul>
</section>
<section id="interrupts-exceptions" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="interrupts-exceptions"><span class="header-section-number">5.3</span> Interrupts &amp; Exceptions</h2>
<p>From Tomasulo, we know branches don’t work well with wrong predictions since we need to clean up OoO execution of the instructions already inside the pipeline. Another problem is when dealing with interrupts &amp; exceptions.</p>
<p>Interrupts and exceptiosn are <strong>unexpected transfer of control flow</strong> that is restartable (pick up where we left off from before).</p>
<ul>
<li><strong>Asynchronous (Interrupts)</strong>
<ul>
<li>E.g. I/O device wants attention</li>
<li>Allows that we defer the interrupt until it is convenient
<ul>
<li>Therefore asynchronous interrupts are easier to deal with than synchronous exceptions</li>
</ul></li>
</ul></li>
<li><strong>Synchronous (aka Exceptions, Traps)</strong>
<ul>
<li>Unusual condition for some instruction
<ul>
<li>E.g. divide by zero, page faults, etc. Need to switch to OS to deal with it or some specialized routine</li>
</ul></li>
<li>Explicit calls to operating system software</li>
<li>Main difference from interrupts is that exceptions are always triggered by some specific instruction
<ul>
<li>Harder to deal with as we can’t just finish current instructions that are running</li>
</ul></li>
</ul></li>
</ul>
<p><img src="images/p6r10k/interrupt-1.png" class="img-fluid"></p>
<p><img src="images/p6r10k/precise-interrupt-1.png" class="img-fluid"></p>
<p><strong>Precise Interrupt</strong> is an abstraction of our program that at any given point in time we should be able to draw a line in our program that separates instructions that are finished and instructions that have not yet finished. Need to somehow “hide” the result of the instructions until we know for sure we have to execute them.</p>
<p>OoO execution messes both branch speculation and precise interrupts. Although precise state is implemented not for performance reasons (rather for programmability), we will get performance improvement since we won’t have to stall as much on branches.</p>
<p><img src="images/p6r10k/spec-interr.png" class="img-fluid"></p>
<ul>
<li>Speculative execution needs
<ul>
<li>Ability to abort &amp; restart at every branch</li>
<li>Abort &amp; restart at every load useful for load speculation (speculation in LSQ)
<ul>
<li>And for shared memory multiprocessing</li>
</ul></li>
</ul></li>
<li>Interrupts and exceptions require abort &amp; restart at every instruction!</li>
<li>The ability to abort &amp; restart at every instruction is <strong>precise state</strong>
<ul>
<li>Ignoring it (imprecise state) makes page faults (or any restartable exception) difficult, and makes speculative execution almost impossible</li>
</ul></li>
</ul>
<section id="precise-state" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="precise-state"><span class="header-section-number">5.3.1</span> Precise State</h3>
<ul>
<li>Options:
<ul>
<li>Force in-order completion (at writeback) and stall if necessary - SLOW!</li>
<li>Implement precise state in software - trap to recovery routine - will need to trap on every branch miss - BAD!</li>
<li>Precise state in HW - way to go!</li>
</ul></li>
</ul>
<p><img src="images/p6r10k/prob-precise-state.png" class="img-fluid"></p>
<ul>
<li>Recall that we split decode into an in-order dispatch and out-of-order issue.</li>
<li>A similar idea can be done with the register file:
<ul>
<li>out of order write to a buffer, in order write to the actual register file</li>
</ul></li>
<li>We turn the instruction buffer into the <strong>Re-Order Buffer (ROB)</strong>
<ul>
<li>Re-order the instructions after executing them out of order, only updating the register file once things are at the head of the ROB (in-order)</li>
<li>Thus: OoO write to ROB, in-order write to RF</li>
</ul></li>
<li>ROB may be combined with RS or used as a separate structure
<ul>
<li>Combined: register-update unit RUU (Sohi’s method)
<ul>
<li>PRos: Saves space, faster operand wakeup and forwarding. Simplifies execution flow</li>
<li>Cons: Scalability issue - entire structure needs to support both scheduling and reordering, complex issue logic</li>
</ul></li>
<li>Separate (more common today): P6 style</li>
</ul></li>
<li>Split Writeback into two stages: Complete and Retire</li>
<li>The ROB defines the <strong>number of instructions that can be in-flight in execution</strong>, essentially defining the size of the <strong>instruction window</strong>, meaning a larger ROB = more future instructions can be considered for execution</li>
</ul>
</section>
<section id="asides---rob-and-rs-sizing" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="asides---rob-and-rs-sizing"><span class="header-section-number">5.3.2</span> Asides - ROB and RS Sizing</h3>
<p><strong>ROB</strong> stores all in-flight instructions from dispatch until they commit in-order</p>
<ul>
<li>Ensures precise state, and in-order retirement</li>
<li>Determines the <strong>instruction window</strong> - how many total instructions can be in-flight</li>
</ul>
<p><strong>RS</strong> holds instructions <strong>waiting for execution</strong></p>
<ul>
<li>Affects instruction issue rate - how many instructions can be issued in parallel</li>
</ul>
<p>“When sizing a reorder buffer (ROB) compared to a reservation station, the ROB generally needs to be larger because it holds the results of instructions until they are ready to commit, while a reservation station only needs to store operands temporarily until the instruction can execute, allowing for more instructions to be in flight during out-of-order execution; meaning a larger ROB is typically required to maintain program correctness while maximizing performance.”</p>
</section>
<section id="complete-retire" class="level3" data-number="5.3.3">
<h3 data-number="5.3.3" class="anchored" data-anchor-id="complete-retire"><span class="header-section-number">5.3.3</span> Complete &amp; Retire</h3>
<p><img src="images/p6r10k/complete-retire.png" class="img-fluid"></p>
<ul>
<li>Complete - where instructions finish execution (but results don’t go to RF yet)
<ul>
<li>Write the results into the ROB, which holds the pending results and forward to pending instructions in the RS</li>
</ul></li>
<li>Retire - where we take the ROB head and wrie the result back into the RF
<ul>
<li>Head is the entry that has been in the ROB the longest (oldest instruction in program order)</li>
<li>“committing” this instruction to the RF</li>
<li>Finishes in program order</li>
</ul></li>
</ul>
</section>
</section>
<section id="p6-style" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="p6-style"><span class="header-section-number">5.4</span> P6 Style</h2>
<p>Basically Tomasulo’s algorithm + ROB, where ROB and RS are separate</p>
<section id="data-structures" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="data-structures"><span class="header-section-number">5.4.1</span> Data Structures</h3>
<ul>
<li><strong>ROB</strong>
<ul>
<li>head, tail: pointers to maintain sequential order
<ul>
<li>Head is oldest insn, tail is youngest</li>
</ul></li>
<li>R: instruction destination register</li>
<li>V: instruction output value</li>
<li>Each instruction gets a ROB entry</li>
<li>Helps solve following problems:
<ul>
<li>Main motivation: preventing writing back an instruction that wasn’t supposed to (in-order retire)</li>
<li>Resolve name dependencies</li>
</ul></li>
</ul></li>
<li>Reservation Station - same as in Tomasulo</li>
<li><strong>Map Table</strong>:
<ul>
<li>Keeps track of which ROB entries holds latest values for each architectural register (maps arch reg -&gt; ROB#)</li>
<li>Different from Tomasulo:</li>
<li>Stores T+: tag + “ready-in-ROB” bit</li>
<li>If T is empty, value is ready in the RF</li>
<li>If T is not empty (but no + bit), value is not ready</li>
<li>If T is not empty with + bit, value is ready in the ROB</li>
</ul></li>
<li>Tags are different:
<ul>
<li>Tomasulo uses RS# as Tag</li>
<li>P6 uses ROB# as Tag (since ROB# corresponds to an instruction)</li>
</ul></li>
</ul>
<p><img src="images/p6r10k/p6-ds.png" class="img-fluid"></p>
<p>What about loads and stores?</p>
<ul>
<li>We can’t resolve data dependencies between loads and stores until we actually execute the instruction (need to compute address first)</li>
<li>Need extra hardware structure: Load Store Queue (LSQ) - see notes later on this
<ul>
<li>Completed stores write to LSQ</li>
<li>When stores retire, the head of the LSQ (oldest ins) gets written to D-cache</li>
<li>When loads execute, access LSQ and D$ in parallel
<ul>
<li>Forward data from LSQ if older store has a matching address</li>
</ul></li>
<li>More modern designs: have loads and stores in separate queues</li>
</ul></li>
</ul>
<p><img src="images/p6r10k/rob-lsq-p6.png" class="img-fluid"></p>
</section>
<section id="pipeline" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="pipeline"><span class="header-section-number">5.4.2</span> Pipeline</h3>
<p>Pipeline: Fetch, Decode, Issue, Execute, Complete, Retire</p>
<ul>
<li><strong>Dispatch</strong>
<ul>
<li>If structural hazard on ROB/LSQ/RS then Stall
<ul>
<li>Since dispatching an instruction requires us to send insn to these structures</li>
<li>Note: if non-memory dispatching insn and LSQ is full, it is fine</li>
</ul></li>
<li>Allocate entry in ROB/LSQ/RS</li>
<li>Set RS tag to the ROB#</li>
<li>Set the Map Table entry to the ROB# and clear “ready-in-ROB” bit</li>
<li>Read ready registers into RS (from either ROB or RF)</li>
</ul></li>
<li><strong>Execute</strong>
<ul>
<li>Free RS entry
<ul>
<li>Note: recall how in Tomasulo we freed RS entry at writeback. This is moved earlier here because RS# are no longer tags</li>
</ul></li>
</ul></li>
<li><strong>Complete</strong>
<ul>
<li>If there’s structural hazard on the CDB, then wait</li>
<li>Write value into ROB entry indicated by the RS tag</li>
<li>Mark the ROB entry as Complete
<ul>
<li>If the ROB entry overwritten, mark Map Table entry “ready-in-ROB” bit (+)</li>
<li>i.e.&nbsp;if in the Map Table, the arch reg -&gt; ROB# (of the completed insn) is still there and not overwritten by a new instruction, then we set the “ready-in-ROB” bit since we now have the value. Otherwise the arch. reg. is overwritten by a newer instruction and needs a different value.</li>
</ul></li>
</ul></li>
<li><strong>Retire</strong>
<ul>
<li>If instruction at ROB head not complete? Stall</li>
<li>Handle any exceptions</li>
<li>Write ROB head value to register file</li>
<li>If store instruction at head, write the LSQ head to the D-cache</li>
<li>Free ROB/LSQ entries that are retired</li>
</ul></li>
</ul>
</section>
<section id="p6-dispatch" class="level3" data-number="5.4.3">
<h3 data-number="5.4.3" class="anchored" data-anchor-id="p6-dispatch"><span class="header-section-number">5.4.3</span> P6 Dispatch</h3>
<p><img src="images/p6r10k/p6dispatch-1.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6-dispatch-2.png" class="img-fluid"></p>
</section>
<section id="p6-complete" class="level3" data-number="5.4.4">
<h3 data-number="5.4.4" class="anchored" data-anchor-id="p6-complete"><span class="header-section-number">5.4.4</span> P6 Complete</h3>
<p><img src="images/p6r10k/p6-complete.png" class="img-fluid"></p>
</section>
<section id="p6-retire" class="level3" data-number="5.4.5">
<h3 data-number="5.4.5" class="anchored" data-anchor-id="p6-retire"><span class="header-section-number">5.4.5</span> P6 Retire</h3>
<p><img src="images/p6r10k/p6-retire.png" class="img-fluid"></p>
</section>
<section id="precise-state-in-p6" class="level3" data-number="5.4.6">
<h3 data-number="5.4.6" class="anchored" data-anchor-id="precise-state-in-p6"><span class="header-section-number">5.4.6</span> Precise State in P6</h3>
<p>Point of the ROB is to maintain <strong>Precise State</strong></p>
<ul>
<li>To do so:
<ul>
<li>Wait until last good instruction retires such that the first bad instruction is at the ROB head
<ul>
<li>Good as in insn should be finished as usual, bad as in insn that shouldn’t be run (such as insns after a mis-predicted branch)</li>
</ul></li>
<li>Then clear the contents of the ROB, RS, and Map Table</li>
<li>Start over (start running the pipeline again from the correct instructions)</li>
</ul></li>
<li>This works because ROB helps us maintain program order, and we clear everything that should be flushed</li>
</ul>
</section>
<section id="p6" class="level3" data-number="5.4.7">
<h3 data-number="5.4.7" class="anchored" data-anchor-id="p6"><span class="header-section-number">5.4.7</span> P6</h3>
<p>What is the cost of adding precise state?</p>
<ul>
<li>In general, P6 has same performance as “plain” Tomasulo
<ul>
<li>ROB is not designed to make system more performant (although it may give a little speedup since RS freed earlier leads to fewer structural hazards)</li>
</ul></li>
<li>Rule of Thumb for ROB Size:
<ul>
<li>At least N <span class="math inline">\(\times\)</span> number of pipe stages bewteen D and R
<ul>
<li>Need to make sure ROB covers pipeline</li>
</ul></li>
<li>At least <span class="math inline">\(N \times t_{hit-L2}\)</span>
<ul>
<li>Miss in L1 cache is most comon reason for a stall, thus if we can make sure the number of instructions “in flight” is N times hit time of L2 cache, this makes sure even if we have a miss on L1 we can keep fetching instructions to keep the CPU busy</li>
</ul></li>
</ul></li>
<li>The problem with P6 for high performance implementations:
<ul>
<li>Too much <strong>value movement</strong> (regfile/ROB -&gt; RS -&gt; ROB -&gt; RF)</li>
<li>Multi-input MUXes, long buses complicate routing and slows clock</li>
<li>We’re moving values around a lot, could have many different copies of the same value
<ul>
<li>This motivates us towards a R10K design where we have 1 value and keep track of where things are</li>
</ul></li>
</ul></li>
</ul>
</section>
</section>
<section id="mips-r10k" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="mips-r10k"><span class="header-section-number">5.5</span> MIPS R10K</h2>
<p>An alternative implementation is a MIPS R10K-style architecture</p>
<p><img src="images/p6r10k/r10k-diagram.png" class="img-fluid"></p>
<ul>
<li>Big idea: Have all data in one place
<ul>
<li>Use one big physical register file to hold all data - no copies</li>
</ul></li>
<li>Register files are close to FUs, leading to small &amp; fast data path</li>
<li>ROB and RS “on the side” used for only control and tags</li>
</ul>
<section id="r10k-register-renaming" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="r10k-register-renaming"><span class="header-section-number">5.5.1</span> R10K Register Renaming</h3>
<p>No more architectural register file. Instead the <strong>physical register file</strong> holds all values.</p>
<ul>
<li>Num. of Physical Registers = Num. of Arch. Regs + Num. ROB Entries</li>
<li>Map architectural registers to physical registers
<ul>
<li>This removes name hazards (WAW, WAR). Compared to P6, phys. reg. replace RS copies</li>
</ul></li>
<li>Big change to <strong>map table</strong>: each entry in the table always contains some mapping to physical registers (since there is no arch. register file anymore)</li>
<li><strong>Free List</strong> keeps track of unallocated physical registers that we can assign to
<ul>
<li>ROB is responsible for returning physical registers to the free list</li>
<li>Can be implemented with a bit array, one bit for each physical register, tracking if the register is free or not</li>
</ul></li>
<li>Conceptually, this is “true register renaming”</li>
</ul>
<p>How do we free registers?</p>
<ul>
<li>In P6, values were temporarily stored with the ROB entry. On retire, ROB value is copied to the RF, freeing the ROB entry</li>
<li>However in R10k, we can’t free physical registers when instruction retires
<ul>
<li>There is no architectural register to copy the value to… other instructions might need this value</li>
</ul></li>
<li>Notice: We can free physical register that is previously mapped to same logical register
<ul>
<li>Why? All insns that will ever read its value have retired</li>
<li>In otherwords:</li>
<li>Once we retire an instruction, we know for sure that previous physical registers that used this destReg won’t be used anymore. Any instructions being executed now must be using the newer version of the register</li>
</ul></li>
</ul>
</section>
<section id="r10k-data-structures" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="r10k-data-structures"><span class="header-section-number">5.5.2</span> R10K Data Structures</h3>
<ul>
<li><strong>ROB</strong>
<ul>
<li>T: Physical register # corresponding to the instruction’s logical output</li>
<li>T_old: physical register # <em>previously</em> mapped to instruction’s logical output
<ul>
<li>This is so that we know what physical register to free</li>
</ul></li>
</ul></li>
<li><strong>RS</strong>
<ul>
<li>T, T1, T2: output and two input physical register numbers</li>
</ul></li>
<li><strong>Map Table</strong>
<ul>
<li>Stores the mapping from arch. reg to physical registers</li>
<li>T+: Physica Reg # + “ready bit”</li>
<li>Note that map table entires are never empty</li>
</ul></li>
<li><strong>Architectural Map Table</strong>
<ul>
<li>T: Physical Reg #</li>
<li>Can be used to restore state after a branch mispredict or exception</li>
<li>Keeps a separate version of the map table that doesn’t hold speculative updates
<ul>
<li>Speculative as in instructions that are in-flight</li>
<li>Only gets updated on <strong>retire</strong> (in-order)</li>
<li>When clearing out processor pipeline, this tells us where the “official” register values are kept at any given time</li>
</ul></li>
</ul></li>
<li><strong>Free List</strong>
<ul>
<li>T: Physical Reg #</li>
<li>Tracks what physical registers are free</li>
</ul></li>
</ul>
<p>Key differences from P6:</p>
<ul>
<li>New tags: R10K tags are Physical Register # (compared to ROB# in P6)</li>
<li>No register values are stored in ROB, RS, or on CDB
<ul>
<li>This is key for hardware since this minimizes overheads spent on value copies, especially the CDB (which adds significant routing costs, etc)!</li>
</ul></li>
</ul>
</section>
<section id="r10k-pipeline" class="level3" data-number="5.5.3">
<h3 data-number="5.5.3" class="anchored" data-anchor-id="r10k-pipeline"><span class="header-section-number">5.5.3</span> R10K Pipeline</h3>
<p><img src="images/p6r10k/r10k-datastruct.png" class="img-fluid"></p>
<ul>
<li>Fetch</li>
<li>Dispatch
<ul>
<li>On structural hazard (RS, ROB, LSQ, or Physical Registers), then stall</li>
<li>Allocate RS, ROB, LSQ entries and a new physical register (T)</li>
<li>Record the previously mapped physical register (T_old)</li>
</ul></li>
<li>Complete
<ul>
<li>Write value to destination physical register</li>
</ul></li>
<li>Retire
<ul>
<li>If ROB head not complete, stall</li>
<li>Handle any exceptions</li>
<li>Store write LSQ head to D cache</li>
<li>Free the ROB and LSQ entries that is retiring</li>
<li><strong>Free previous physical register (T_old)</strong></li>
<li>Record committed physical register (T) (to architectural map table)</li>
</ul></li>
</ul>
</section>
<section id="dispatch" class="level3" data-number="5.5.4">
<h3 data-number="5.5.4" class="anchored" data-anchor-id="dispatch"><span class="header-section-number">5.5.4</span> Dispatch</h3>
<p><img src="images/p6r10k/r10k-disp.png" class="img-fluid"></p>
<ul>
<li>Allocate entry at tail of ROB</li>
<li>Allocate RS entry and populate values</li>
<li>Allocate physical reg on free list to Map table</li>
</ul>
</section>
<section id="complete" class="level3" data-number="5.5.5">
<h3 data-number="5.5.5" class="anchored" data-anchor-id="complete"><span class="header-section-number">5.5.5</span> Complete</h3>
<p><img src="images/p6r10k/r10k-comp.png" class="img-fluid"></p>
</section>
<section id="retire" class="level3" data-number="5.5.6">
<h3 data-number="5.5.6" class="anchored" data-anchor-id="retire"><span class="header-section-number">5.5.6</span> Retire</h3>
<p><img src="images/p6r10k/r10k-retire.png" class="img-fluid"></p>
</section>
<section id="precise-state-in-r10k" class="level3" data-number="5.5.7">
<h3 data-number="5.5.7" class="anchored" data-anchor-id="precise-state-in-r10k"><span class="header-section-number">5.5.7</span> Precise State in R10k</h3>
<p>Disadvantage of R10K is that precise state has more overhead</p>
<ul>
<li>On exception/mispredict, copy arch. map table into map table
<ul>
<li>Also need to keep an architectural free list
<ul>
<li>To track free physical registers after retirement</li>
</ul></li>
</ul></li>
<li>Alternative: Serially rollback execution using T, T_old ROB fields
<ul>
<li>Very slow but costs less hardware (since no need for architectural map table)</li>
</ul></li>
</ul>
</section>
</section>
<section id="summary" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="summary"><span class="header-section-number">5.6</span> Summary</h2>
<p><img src="images/p6r10k/p6r10k-comp-ren.png" class="img-fluid"></p>
<ul>
<li>Modern dynamic scheduling must support precise state (programmability)</li>
<li>Strategy: Split writeback into Complete (OoO) + Retire (in order)</li>
<li>Two basic designs:
<ul>
<li>P6: Tomasulo + ROB, copy-based register renaming
<ul>
<li>Precise state is simple, but fast implementation difficult (due to value copies)</li>
</ul></li>
<li>R10K: Implements “true” register renaming
<ul>
<li>Easier fast implementation, but precise state is more complex</li>
</ul></li>
</ul></li>
</ul>
<p><img src="images/p6r10k/p6r10k-dyn-sch-summary.png" class="img-fluid"></p>
</section>
<section id="examples" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="examples"><span class="header-section-number">5.7</span> Examples</h2>
<section id="p6-execution" class="level3" data-number="5.7.1">
<h3 data-number="5.7.1" class="anchored" data-anchor-id="p6-execution"><span class="header-section-number">5.7.1</span> P6 Execution</h3>
<p><img src="images/p6r10k/p6-exe1.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c1.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c2.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c3.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c4.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c5.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c6.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c7.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c8.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c9.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c10.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c11.png" class="img-fluid"></p>
<section id="p6-with-precise-state" class="level4" data-number="5.7.1.1">
<h4 data-number="5.7.1.1" class="anchored" data-anchor-id="p6-with-precise-state"><span class="header-section-number">5.7.1.1</span> P6 With Precise State</h4>
<p><img src="images/p6r10k/p6c9-ps.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c10-ps.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c11-ps.png" class="img-fluid"></p>
<p><img src="images/p6r10k/p6c12-ps.png" class="img-fluid"></p>
</section>
<section id="r10k-execution" class="level4" data-number="5.7.1.2">
<h4 data-number="5.7.1.2" class="anchored" data-anchor-id="r10k-execution"><span class="header-section-number">5.7.1.2</span> R10K Execution</h4>
<p><img src="images/p6r10k/r10kc0.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc1.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc2.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc3.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc4.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc5.png" class="img-fluid"></p>
</section>
<section id="r10k-with-precise-state" class="level4" data-number="5.7.1.3">
<h4 data-number="5.7.1.3" class="anchored" data-anchor-id="r10k-with-precise-state"><span class="header-section-number">5.7.1.3</span> R10K with Precise State</h4>
<p><img src="images/p6r10k/r10kc5-ps.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc6-ps.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc7-ps.png" class="img-fluid"></p>
<p><img src="images/p6r10k/r10kc8-ps.png" class="img-fluid"></p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ooo-basics.html" class="pagination-link" aria-label="Out-of-Order - Dynamic Scheduling, Tomasulo">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Out-of-Order - Dynamic Scheduling, Tomasulo</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./ooo-memory.html" class="pagination-link" aria-label="Memory Disambiguation">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Memory Disambiguation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>